name: Kernel Build

on:
  repository_dispatch:
    types: [manual-build]
  workflow_dispatch:

jobs:
 KernelSU:
    name: Build on ubuntu-latest
    runs-on: ubuntu-latest

    steps:
      - name: Set swap to 10G
        uses: pierotofy/set-swap-space@master
        with:
          swap-size-gb: 10
    
      - name: Install dependencies
        run: |
          cd $GITHUB_WORKSPACE
          mkdir K50 && cd K50
          sudo apt update && sudo apt install repo -y
          sudo git config --global user.name "root"
          sudo git config --global user.email "localhost"
          sudo timedatectl set-timezone Asia/Shanghai

      - name: Clone source code
        run: |
          repo init --depth=1 -u https://android.googlesource.com/kernel/manifest -b common-android12-5.10-2024-03 --repo-rev=stable
          repo sync
          cd common
          wget https://github.com/wu17481748/lxc-docker/releases/download/lxc-docker-2config/LXC-DOCKER-OPEN-CONFIG.sh
          chmod 777 LXC-DOCKER-OPEN-CONFIG.sh
          ./LXC-DOCKER-OPEN-CONFIG.sh ./arch/arm64/configs/gki_defconfig -w
          wget https://github.com/wu17481748/lxc-docker/releases/download/lxc/lxc.patch
          patch -p0 < lxc.patch
          curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -s main
          cd KernelSU
          echo "KSU_VERSION=$(($(git rev-list --count HEAD) + 10200))" >> $GITHUB_ENV
         

      - name: Build images
        run: |
          sed -i 's/ -dirty//g' common/scripts/setlocalversion
          sed -i 's/check_defconfig//g' common/build.config.gki
          LTO=thin BUILD_CONFIG=common/build.config.gki.aarch64 build/build.sh
          
      - name: Upload build artifact
        uses: actions/upload-artifact@v3
        with:
          name: Image
          path: out/android12-5.10/dist/Image

      - name: Release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: latest
          name: Image 
          files: out/android12-5.10/dist/Image
       
          

 

